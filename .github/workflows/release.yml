name: Release (Tag-Based)

# Explicit permissions for clarity
permissions:
  contents: write  # needed to create releases and upload release assets

on:
  push:
    tags:
      - "v*"  # triggers on version tags like v1.0

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install build tools (Linux only)
      - name: Install build tools
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y build-essential
        shell: bash
        
      # 3. Extract version number from tag
      - name: Extract version
        id: get_version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
        shell: bash
        
      # 4. Build citeorder and test_citeorder
      - name: Build binaries
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            gcc -Wall -Wextra -O2 -o citeorder.exe citeorder.c
            gcc -Wall -Wextra -O2 -o test_citeorder.exe test_citeorder.c
          else
            gcc -Wall -Wextra -O2 -o citeorder citeorder.c
            gcc -Wall -Wextra -O2 -o test_citeorder test_citeorder.c
          fi
        shell: bash
          
      # 5. Run integration tests
      - name: Run integration tests
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ./test_citeorder.exe
          else
            ./test_citeorder
          fi
        shell: bash

      # 6. Package binaries with LICENSE and README
      - name: Package archive
        run: |
          VERSION=${{ steps.get_version.outputs.version }}

          # Determine OS name for archive
          case "${{ matrix.os }}" in
            ubuntu-latest) OSNAME="Ubuntu" ;;
            macos-latest)  OSNAME="macOS" ;;
            windows-latest) OSNAME="Windows" ;;
          esac

          ARCH="x86_64"
          mkdir package

          # Copy binaries
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp citeorder.exe package/
          else
            cp citeorder package/
          fi

          # Include LICENSE and README
          cp LICENSE README.md package/

          # Create archive
          cd package
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            pwsh -Command "Compress-Archive -Path citeorder.exe,LICENSE,README.md -DestinationPath ../citeorder-${VERSION}-${OSNAME}-${ARCH}.zip"
          else
            tar -czvf ../citeorder-${VERSION}-${OSNAME}-${ARCH}.tar.gz *
          fi
          cd ..
        shell: bash

      # 7. Upload artifact for use in release job
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: citeorder-${{ matrix.os }}
          path: |
            citeorder-*.zip
            citeorder-*.tar.gz


  build-wasm:
    name: Build WASM (Emscripten)
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Extract version from tag
      - name: Extract version
        id: get_version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      # 3. Install Emscripten
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      # 4. Verify emcc
      - name: Verify emcc
        run: emcc --version

      # 5. Build WASM
      - name: Build citeorder WASM
        run: |
          mkdir wasm
          emcc citeorder.c \
            -O3 \
            -s WASM=1 \
            -s MODULARIZE=1 \
            -s EXPORT_NAME=CiteorderModule \
            -s EXPORTED_RUNTIME_METHODS='["callMain","FS"]' \
            -s ALLOW_MEMORY_GROWTH=1 \
            -s INITIAL_MEMORY=16777216 \
            -s ENVIRONMENT=web \
            -s EXPORT_ES6=0 \
            -s SINGLE_FILE=0 \
            -s ASSERTIONS=1 \
            -o wasm/citeorder.js

      # 6. Package WASM zip
      - name: Package WASM
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          mkdir package
          cp wasm/citeorder.js wasm/citeorder.wasm package/
          cp LICENSE README.md package/
          cd package
          zip -9 ../citeorder-wasm-${VERSION}.zip *

      # 7. Upload WASM artifact
      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: citeorder-wasm
          path: citeorder-wasm-*.zip


  release:
    needs:
      - build-and-test
      - build-wasm
    runs-on: ubuntu-latest

    steps:
      # 1. Download all artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # 2. Optional â€” list to confirm paths
      - name: List downloaded files
        run: ls -R ./artifacts

      # 3. Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/citeorder-Ubuntu/*.tar.gz
            ./artifacts/citeorder-macOS/*.tar.gz
            ./artifacts/citeorder-Windows/*.zip
            ./artifacts/citeorder-wasm/*.zip
          tag_name: ${{ github.ref_name }}
          body: "Automated release of citeorder ${{ github.ref_name }}."
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
